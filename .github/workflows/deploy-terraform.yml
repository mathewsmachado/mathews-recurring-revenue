on:
  workflow_call:
    inputs:
      gcp-project-id:
        required: true
        type: string
      gcp-workload-identity-provider:
        required: true
        type: string
      gcp-service-account:
        required: true
        type: string
      terraform-project:
        required: true
        type: string

env:
  terraform-version: "1.12.2"
  terraform-plan-file-retention-days: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.gcp-project-id }}
  cancel-in-progress: true

jobs:
  terraform-validate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        working-directory: ${{ inputs.terraform-project }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - uses: ./.github/actions/setup-terraform-on-gcp
        with:
          gcp-project-id: ${{ inputs.gcp-project-id }}
          gcp-workload-identity-provider: ${{ inputs.gcp-workload-identity-provider }}
          gcp-service-account: ${{ inputs.gcp-service-account }}
          terraform-project: ${{ inputs.terraform-project }}
          terraform-version: ${{ env.terraform-version }}

      - name: Terraform Validate
        id: terraform-validate
        run: terraform validate -no-color

      - uses: ./.github/actions/comment-terraform-command-result-on-pull-request
        with:
          message_title: Terraform Validate [${{ inputs.gcp-project-id }}]
          command-outcome: ${{ steps.terraform-validate.outcome }}
          command-stdout: ${{ steps.terraform-validate.outputs.stdout }}
          command-stderr: ${{ steps.terraform-validate.outputs.stderr }}

  terraform-plan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    needs: terraform-validate

    defaults:
      run:
        working-directory: ${{ inputs.terraform-project }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - uses: ./.github/actions/setup-terraform-on-gcp
        with:
          gcp-project-id: ${{ inputs.gcp-project-id }}
          gcp-workload-identity-provider: ${{ inputs.gcp-workload-identity-provider }}
          gcp-service-account: ${{ inputs.gcp-service-account }}
          terraform-project: ${{ inputs.terraform-project }}
          terraform-version: ${{ env.terraform-version }}

      - name: Terraform Plan
        id: terraform-plan
        run: terraform plan -no-color -out=${{ inputs.gcp-project-id }}

      - name: Persist Terraform Plan Output File
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.gcp-project-id }}
          path: ${{ inputs.terraform-project }}/${{ inputs.gcp-project-id }}
          retention-days: ${{ env.terraform-plan-file-retention-days }}

      - uses: ./.github/actions/comment-terraform-command-result-on-pull-request
        with:
          message_title: Terraform Plan [${{ inputs.gcp-project-id }}]
          command-outcome: ${{ steps.terraform-plan.outcome }}
          command-stdout: ${{ steps.terraform-plan.outputs.stdout }}
          command-stderr: ${{ steps.terraform-plan.outputs.stderr }}

  terraform-apply:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    environment: terraform-manual-approval

    needs: terraform-plan

    defaults:
      run:
        working-directory: ${{ inputs.terraform-project }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - uses: ./.github/actions/setup-terraform-on-gcp
        with:
          gcp-project-id: ${{ inputs.gcp-project-id }}
          gcp-workload-identity-provider: ${{ inputs.gcp-workload-identity-provider }}
          gcp-service-account: ${{ inputs.gcp-service-account }}
          terraform-project: ${{ inputs.terraform-project }}
          terraform-version: ${{ env.terraform-version }}

      - name: Retrieve Terraform Plan File
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.gcp-project-id }}
          path: ${{ inputs.terraform-project }}

      - name: Terraform Apply
        id: terraform-apply
        run: terraform apply -no-color -auto-approve ${{ inputs.gcp-project-id }}

      - uses: ./.github/actions/comment-terraform-command-result-on-pull-request
        with:
          message_title: Terraform Apply [${{ inputs.gcp-project-id }}]
          command-outcome: ${{ steps.terraform-apply.outcome }}
          command-stdout: ${{ steps.terraform-apply.outputs.stdout }}
          command-stderr: ${{ steps.terraform-apply.outputs.stderr }}
