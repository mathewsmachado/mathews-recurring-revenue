on:
  workflow_call:
    inputs:
      gcp-project-id:
        required: true
        type: string
      gcp-workload-identity-provider:
        required: true
        type: string
      gcp-service-account:
        required: true
        type: string
      gcp-artifacts-bucket:
        required: true
        type: string

env:
  DBT_TARGET: dev
  GCP_CLIENT_EMAIL: dbt-project@mathews-recurring-revenue-stg.iam.gserviceaccount.com
  # GCP_LOCATION: US
  GCP_LOCATION: us-central1
  GCP_PROJECT_ID: mathews-recurring-revenue-stg
  # MMRR_ACCOUNTING_LIFE_START_DATE: '2022-01-04'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.gcp-project-id }}
  cancel-in-progress: true

jobs:
  dbt-project-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        working-directory: dbt_project

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5
        
      - uses: ./.github/actions/authenticate-to-gcp
        id: gcp-auth
        with:
          gcp-project-id: ${{ inputs.gcp-project-id }}
          gcp-workload-identity-provider: ${{ inputs.gcp-workload-identity-provider }}
          gcp-service-account: ${{ inputs.gcp-service-account }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "dbt_project/.python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.21"
          enable-cache: true

      - name: Install Python Dependencies
        run: uv sync

      - name: Install dbt Dependencies
        run: uv run dbt deps

      - name: Download manifest.json
        run: |
          gcloud storage cp \
            ${{ inputs.gcp-artifacts-bucket }}/target/manifest.json \
            artifacts/manifest.json || {
              echo "No manifest.json found."
              exit 1
            }

      - name: Run Unit Tests
        run: |
          uv run dbt test \
            --defer \
            --state artifacts \
            --select state:modified,test_type:unit

      - name: Run Modified Seeds
        run: |
          uv run dbt seed --defer --state artifacts --select state:modified

      - name: Run Modified Models
        run: |
          uv run dbt run --defer --state artifacts --select state:modified

      - name: Upload manifest.json
        run: |
          gcloud storage cp \
            target/manifest.json \
            ${{ inputs.gcp-artifacts-bucket }}/target/manifest.json

      - name: Generate Docs
        run: |
          uv run dbt docs generate \
            --static \
            --no-compile \
            --defer \
            --state artifacts \
            --select state:modified

      - name: Upload Docs
        run: |
          gcloud storage cp \
            target/static_index.html \
            ${{ inputs.gcp-artifacts-bucket }}/target/static_index.html

      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.gcp-auth.outputs.access_token }}

      - name: Generate Docker Metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: us-central1-docker.pkg.dev/mathews-recurring-revenue-dev/dbt-project/dbt-project
          tags: type=sha

      - name: Docker Build and Push
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:dbt_project"
          push: true
          tags: ${{ steps.docker-meta.outputs.tags }}
