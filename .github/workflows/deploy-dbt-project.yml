on:
  workflow_call:
    inputs:
      gcp-project-id:
        required: true
        type: string
      gcp-workload-identity-provider:
        required: true
        type: string
      gcp-service-account:
        required: true
        type: string
      gcp-artifacts-bucket:
        required: true
        type: string

env:
  GOOGLE_CLOUD_CLIENT_EMAIL: dbt-project@mathews-recurring-revenue-stg.iam.gserviceaccount.com
  GOOGLE_CLOUD_PROJECT: mathews-recurring-revenue-stg

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.gcp-project-id }}
  cancel-in-progress: true

jobs:
  dbt-project-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    defaults:
      run:
        working-directory: dbt_project

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - uses: ./.github/actions/authenticate-to-gcp
        # id: gcp-auth
        with:
          gcp-project-id: ${{ inputs.gcp-project-id }}
          gcp-workload-identity-provider: ${{ inputs.gcp-workload-identity-provider }}
          gcp-service-account: ${{ inputs.gcp-service-account }}

      # - name: Setup Python
      #   uses: actions/setup-python@v6
      #   with:
      #     python-version-file: "dbt_project/.python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.21"
          enable-cache: true

      - name: Set up Python
        run: uv python install

      - name: Install Python Dependencies
        run: uv sync

      - name: Install dbt Dependencies
        run: uv run dbt deps

      - name: Download manifest.json
        run: |
          gcloud storage cp \
            ${{ inputs.gcp-artifacts-bucket }}/target/manifest.json \
            artifacts/manifest.json || {
              echo "No manifest.json found."
              exit 1
            }

      - name: Run Unit Tests
        run: |
          uv run dbt test \
            --defer \
            --state artifacts \
            --select state:modified,test_type:unit

      - name: Run Modified Seeds
        run: |
          uv run dbt seed --defer --state artifacts --select state:modified

      - name: Run Modified Models
        run: |
          uv run dbt run --defer --state artifacts --select state:modified

      - name: Upload manifest.json
        run: |
          gcloud storage cp \
            target/manifest.json \
            ${{ inputs.gcp-artifacts-bucket }}/target/manifest.json

      - name: Generate Docs
        run: |
          uv run dbt docs generate \
            --static \
            --no-compile \
            --defer \
            --state artifacts \
            --select state:modified

      - name: Upload Docs
        run: |
          gcloud storage cp \
            target/static_index.html \
            ${{ inputs.gcp-artifacts-bucket }}/target/static_index.html

      - name: Build Docker Image
        run: |
          docker build \
            --tag us-central1-docker.pkg.dev/${{ inputs.gcp-project-id }}/dbt-project/dbt-project:${{ github.event.pull_request.head.sha }} \
            .

      - name: Authenticate to Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Push Docker Image
        run: |
          docker push us-central1-docker.pkg.dev/${{ inputs.gcp-project-id }}/dbt-project/dbt-project:${{ github.event.pull_request.head.sha }}

      - name: Deploy to Cloud Run
        run: |
          DOCKER_IMAGE=us-central1-docker.pkg.dev/${{ inputs.gcp-project-id }}/dbt-project/dbt-project:${{ github.event.pull_request.head.sha }} \
          GOOGLE_CLOUD_SERVICE_ACCOUNT=${{ inputs.gcp-service-account }} \
          envsubst < job.yaml |
          gcloud run jobs replace \
          --project=${{ env.GOOGLE_CLOUD_PROJECT }} \
          --region=us-central1 \
          -
