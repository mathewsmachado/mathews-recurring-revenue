name: Terraform Deploy Production

on:
  pull_request:
    branches:
      - main
    paths:
      - terraform/mathews-recurring-revenue-prd/**.tf

jobs:
  terraform-prd-validate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    outputs:
      summary: ${{ steps.persist_result.outputs.summary }}
      details: ${{ steps.persist_result.outputs.details }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      # https://github.com/google-github-actions/auth
      - name: Authenticate to Google Cloud Platform
        uses: google-github-actions/auth@v3
        with:
          project_id: mathews-recurring-revenue-prd
          workload_identity_provider: projects/753917517701/locations/global/workloadIdentityPools/github/providers/mathews-recurring-revenue
          service_account: github@mathews-recurring-revenue-prd.iam.gserviceaccount.com

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.2"

      - name: Terraform Init
        run: terraform -chdir=terraform/mathews-recurring-revenue-prd init -no-color

      - name: Terraform Validate
        id: terraform_command
        run: terraform -chdir=terraform/mathews-recurring-revenue-prd validate -no-color

      - name: Persist Terraform Validate Output
        id: persist_result
        run: |
          {
            echo 'summary<<EOF'
            echo '${{ steps.terraform_command.outcome }}'
            echo 'EOF'

            echo 'details<<EOF'
            echo '${{ steps.terraform_command.outputs.stdout }}'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  terraform-prd-plan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    needs: terraform-prd-validate

    outputs:
      summary: ${{ steps.persist_result.outputs.summary }}
      details: ${{ steps.persist_result.outputs.details }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud Platform
        uses: google-github-actions/auth@v3
        with:
          project_id: mathews-recurring-revenue-prd
          workload_identity_provider: projects/753917517701/locations/global/workloadIdentityPools/github/providers/mathews-recurring-revenue
          service_account: github@mathews-recurring-revenue-prd.iam.gserviceaccount.com

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.2"

      - name: Terraform Init
        run: terraform -chdir=terraform/mathews-recurring-revenue-prd init -no-color

      - name: Terraform Plan
        id: terraform_command
        run: terraform -chdir=terraform/mathews-recurring-revenue-prd plan -out=mathews-recurring-revenue-prd.tfplan -no-color

      - name: Persist Terraform Plan File
        uses: actions/upload-artifact@v4
        with:
          name: mathews-recurring-revenue-prd.tfplan
          path: terraform/mathews-recurring-revenue-prd/mathews-recurring-revenue-prd.tfplan
          retention-days: 1

      - name: Persist Terraform Plan Output
        id: persist_result
        run: |
          {
            echo 'summary<<EOF'
            echo '${{ steps.terraform_command.outcome }}'
            echo 'EOF'

            echo 'details<<EOF'
            echo '${{ steps.terraform_command.outputs.stdout }}'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  terraform-prd-print-validate-and-plan:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    needs:
      - terraform-prd-validate
      - terraform-prd-plan

    steps:
      - name: Decorate PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            <h2>Terraform</h2>

            <details>
              <summary>
                <b>Validation:</b>
                <span>${{ needs.terraform-prd-validate.outputs.summary }}</span>
              </summary>

              <pre>${{ needs.terraform-prd-validate.outputs.details }}</pre>
            </details>

            <details>
              <summary>
                <b>Plan:</b>
                <span>${{ needs.terraform-prd-plan.outputs.summary }}</span>
              </summary>

              <pre>${{ needs.terraform-prd-plan.outputs.details }}</pre>
            </details>
            `

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })

  terraform-prd-apply:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    environment: terraform-manual-approval

    needs: terraform-prd-print-validate-and-plan

    outputs:
      summary: ${{ steps.persist_result.outputs.summary }}
      details: ${{ steps.persist_result.outputs.details }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud Platform
        uses: google-github-actions/auth@v3
        with:
          project_id: mathews-recurring-revenue-prd
          workload_identity_provider: projects/753917517701/locations/global/workloadIdentityPools/github/providers/mathews-recurring-revenue
          service_account: github@mathews-recurring-revenue-prd.iam.gserviceaccount.com

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.2"

      - name: Terraform Init
        run: terraform -chdir=terraform/mathews-recurring-revenue-prd init -no-color

      - name: Retrieve Terraform Plan File
        uses: actions/download-artifact@v5
        with:
          name: mathews-recurring-revenue-prd.tfplan
          path: terraform/mathews-recurring-revenue-prd

      - name: Terraform Apply
        id: terraform_command
        run: terraform -chdir=terraform/mathews-recurring-revenue-prd apply -auto-approve -no-color mathews-recurring-revenue-prd.tfplan

      - name: Persist Terraform Apply Output
        id: persist_result
        run: |
          {
            echo 'summary<<EOF'
            echo '${{ steps.terraform_command.outcome }}'
            echo 'EOF'

            echo 'details<<EOF'
            echo '${{ steps.terraform_command.outputs.stdout }}'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  terraform-prd-print-apply:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    needs: terraform-prd-apply

    steps:
      - name: Decorate PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            <h2>Terraform</h2>

            <details>
              <summary>
                <b>Apply:</b>
                <span>${{ needs.terraform-prd-apply.outputs.summary }}</span>
              </summary>

              <pre>${{ needs.terraform-prd-apply.outputs.details }}</pre>
            </details>
            `

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
